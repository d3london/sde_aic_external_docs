
## MEASUREMENT

### source.{source_table} (BRONZE)

Structured data sources for standardised clinical tests and measurements will generally always include:

| Table                                  | Type            |
|----------------------------------------|-----------------|
| Laboratory information systems              | Legacy + Live          |
| Vital signs recording systems | Legacy + Live          |
| Observation recording flowsheets | Legacy + Live          |

Tables are loaded to the database in batches, or through incremental ingestion via connection to a source database.

### bronze.base_ or stg_{source}__{entity} (BRONZE)

Data sources are staged as `stg_{source}__{entity}` (if necessary, with an initial step of `base_{source}__{entity}` prior to unioning). This may include column renaming and edge case handling.

### silver.int_measurement_laboratorytest (SILVER)

Different data sources are UNIONED into a common dataset for representing categorical or numerical results of laboratory tests.

Patients must first be assigned a `person_uuid`. Where dispensing is attached to a particular hospital admission or attendance, these `spells` or `attendances` must first be assigned a `visit_occurrence_id`.

```{mermaid}
---
title: Measurement (Laboratory) Intermediate Table
---
erDiagram
    int_measurement_laboratorytest {
        measurement_id integer "[PK] autogenerated identifier"
        person_uuid uuid "[FK mrt_person] standardised unique person id"
        measurement_date date
        measurement_datetime datetime    
        measurement_source_value varchar "measurement code as represented in source"
        measurement_source_value_name varchar "measurement name as represented in source"
        domain_id varchar "most relevant omop domain"
        source_vocabulary_id varchar "id of source vocab"
        measurement_location varchar "free text for location context - e.g. ward name, or inpatient, outpatient, TTA"
        operator_source_value varchar "explicit operator as in source"
        value_source_value varchar "verbatim value described in source"
        unit_source_value varchar "verbatim unit as in source"               
        value_as_number float "numerical value of the result of the measurement"
        value_as_categorical varchar "categorical result for visibility"        
        range_low float "normal range low"
        range_high float  "normal range high"
        range_unit varchar "range units"

        drug_desc varchar "additional free text for further qualification, e.g. resupply, new supply"
        route_source_value varchar "route as represented in the source"
        item_formulation_source_value varchar "if available, best string that fully describes item formulation, e.g. 500mg tablet"
        item_strength_quantity_source_value float "strength of one item of drug e.g. 500"
        item_strength_units_source_value varchar "units given to one item e.g. mg"        
        item_type_source_value varchar "type of item, e.g. tablet"
        dose_instruct_source_value varchar "if available, best string that captures dosing instructions, e.g. 1g four times a day"
        dose_quantity_source_value float "dose prescribed e.g. 1"
        dose_unit_source_value varchar "units given to the prescribed dose e.g. g"
        dose_frequency_source_value varchar "dosing instructions e.g. four times a day"
        days_supply integer "how many days given"
        stop_reason varchar "stop reason where given in source"
        sig varchar "additional verbatim instructions for drug"
        visit_occurrence_id integer "[FK mrt_visit_occurrence] standardised unique visit id"
        source_table_provenance varchar "source table name"
        source_row_id uuid "unique row id for the single concept that is generated at ingestion"
    }
```



### OMOP CDM 5.4 - OMOP.MEASUREMENT
The MEASUREMENT table contains records of Measurements, i.e. structured values (numerical or categorical) obtained through systematic and standardized examination or testing of a Person or Person's sample. The MEASUREMENT table contains both orders and results of such Measurements as laboratory tests, vital signs, quantitative findings from pathology reports, etc. Measurements are stored as attribute value pairs, with the attribute as the Measurement Concept and the value representing the result. The value can be a Concept (stored in VALUE_AS_CONCEPT), or a numerical value (VALUE_AS_NUMBER) with a Unit (UNIT_CONCEPT_ID). The Procedure for obtaining the sample is housed in the PROCEDURE_OCCURRENCE table, though it is unnecessary to create a PROCEDURE_OCCURRENCE record for each measurement if one does not exist in the source data. Measurements differ from Observations in that they require a standardized test or some other activity to generate a quantitative or qualitative result. If there is no result, it is assumed that the lab test was conducted but the result was not captured.
```{mermaid}
---
title: OMOP.MEASUREMENT
---
erDiagram
    MEASUREMENT {
        measurement_id integer "[PK not null] autogenerated identifier"
        person_id integer "[FK not null]"
        measurement_concept_id integer "[not null] standard OMOP concept id used for analyses"
        measurement_date date "[not null]"
        measurement_datetime datetime
        measurement_time timestamp
        measurement_type_concept_id integer "[not null] provenance of measurement value per OMOP"
        operator_concept_id integer "omission here is equivalent to '='"         
        value_as_number float "numerical value of the result of the measurement"
        value_as_concept_id integer "standard concept result for categorical values in Meas Value domain"
        unit_concept_id integer
        range_low float
        range_high float
        provider_id integer "[FK] clinician provider who recorded condition"
        visit_occurrence_id integer "[FK]"
        visit_detail_id integer "[FK]"
        measurement_source_value varchar50 "concept code as represented in source"
        measurement_source_concept_id integer "source mapped to omop but often left empty"
        unit_source_value varchar50 "verbatim unit given in source"
        unit_source_concept_id integer "source unit mapped to omop"
        value_source_value varchar50 "verbatim result value of the measurement in source"
        measurement_event_id integer "link to a related record in the db"
        meas_event_field_concept_id integer "concept id identifying the TABLE that is linked"
    }
```

### IMPLEMENTATION - SILVER.MEASUREMENT

SILVER.MEASUREMENT is the cleaned and transformed version of tables and flowsheets that record laboratory values, that are used to stage vanilla OMOP CDM 5.4 tables (as well as other GOLD transformations). This table is wider than the OMOP data model, and includes the following differences:

- Standardised concept codes/names are surfaced, and indexed, to enable user-friendly exploration and visualisation without the need for large joins;
- Source concept codes/names are surfaced to enable direct visibility over semantic provenance;
- value_source_value is transformed and surfaced through operator_concept_name (direct visibility of any operators), value_as_number (OMOP - if clear numerical value), and value_as_categorical (for any string result, that does _not_ necessarily map to OMOP)
- Each row holds information about a single concept relative to a single person. We can therefore incorporate additional, NHS-specific, information about table and systems provenance relative to source data. By extension, this allows for additional understanding of context of data generation, whereas it is often necessary to infer 'OMOP measurement type'.
- OMOP CDM 5.4 columns that are not relevant to the NHS, or to intended purposes, are initialised, but set as null, and remain empty when carried into OMOP.

```{mermaid}
---
title: SILVER.MEASUREMENT
---
erDiagram
    MEASUREMENT {
        measurement_id integer "[PK not null] autogenerated identifier"
        person_id integer "[FK not null]"
        measurement_concept_id integer "[not null] standard OMOP concept id used for analyses"
        measurement_concept_code varchar50 "[NEW] standard OMOP concept code"
        measurement_concept_name varcharMAX "[NEW] standard OMOP concept name"
        measurement_concept_vocabulary_id varchar20 "[FK NEW] OMOP vocabulary id representing the standard concept"              
        measurement_date date "[not null]"
        measurement_datetime timestamp
        measurement_time varchar10
        measurement_type_concept_id integer "[not null] provenance of measurement value per OMOP"
        operator_concept_id integer "omission here is equivalent to '='"
        operator_concept_name varchar10 "[NEW] explicit operator name for visibility"         
        value_as_number float "numerical value of the result of the measurement"
        value_as_concept_id integer "standard concept result for categorical values in Meas Value domain"
        value_as_categorical varchar255 "[NEW] explicit categorical result for visibility"        
        unit_concept_id integer
        unit_concept_name varchar255 "[NEW] explicit unit name for visibility"
        range_low float  "[set as null]"
        range_high float  "[set as null]"
        provider_id integer  "[set as null]"
        visit_occurrence_id integer "[FK]"
        visit_detail_id integer "[set as null]"
        measurement_source_value varchar50 "concept code as represented in source"
        measurement_source_value_name varchar50 "concept name as represented in source"        
        measurement_source_concept_id integer "[set as null]"
        unit_source_value varchar50 "verbatim unit given in source"
        unit_source_concept_id integer "[set as null]"
        value_source_value varchar50 "verbatim result value of the measurement in source"
        measurement_event_id integer "link to a related record in the db"
        meas_event_field_concept_id integer "concept id identifying the TABLE that is linked"
        source_system_provenance varchar50 "[NEW] name of specific system from which source table was ingested"
        source_table_provenance varchar50 "[NEW] source table name"
        source_row_id uuid "[NEW] unique row id for the single concept that is generated at ingestion"          
    }
```


### ADDITIONAL NOTES

None for now!

### OUTSTANDING ISSUES

None for now!
