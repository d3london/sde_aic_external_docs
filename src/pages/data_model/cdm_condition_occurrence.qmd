
## CONDITION_OCCURRENCE

### source.{source_table} (BRONZE)

Structured data sources for patient conditions or diagnoses will generally always include:

| Table                                  | Type            |
|----------------------------------------|-----------------|
| Commissioning Datasets                 | Legacy + Live          |
| Clinical Coding activity outputs | Legacy + Live          |
| Electronic health record system problem lists | Legacy + Live  |

Tables are loaded to the database in batches, or through incremental ingestion via connection to a source database.

### bronze.base_ or stg_{source}__{entity} (BRONZE)

Data sources are staged as `stg_{source}__{entity}` (if necessary, with an initial step of `base_{source}__{entity}` prior to unioning). This may include column renaming and edge case handling.

### silver.int_condition_occurrence (SILVER)

Different data sources are UNIONED into a minimum common dataset for representing the occurrence of conditions, and attached, relevant qualifiers. This table does not contain data from specialty systems such as cancer, which may have additional diagnostic qualifiers.

Diagnosis codes are attached to a particular patient. Patients must first be assigned a `person_uuid`, which is given to the relevant diagnosis in this intermediate stage.

Diagnosis codes may be attached to a particular hospital admission or attendance. These `spells` or `attendances` must first be assigned a `visit_occurrence_id`, which is given to the relevant diagnosis. 

```{mermaid}
---
title: Condition Occurrence Intermediate Table
---
erDiagram
    int_condition_occurrence {
        condition_occurrence_id integer "[PK] autogenerated identifier"
        person_uuid uuid "[FK mrt_person] standardised unique person id"
        condition_start_date date
        condition_start_datetime timestamp
        condition_end_date date
        condition_end_datetime timestamp        
        condition_source_value varchar "condition code as represented in source"
        condition_source_value_name varchar "condition name as represented in source"
        domain_id varchar "most relevant omop domain"
        source_vocabulary_id varchar "id of source vocab"
        condition_diagnosis_order integer "used where diagnoses are ordered, e.g. in commissioning data"
        stop_reason varchar "where given"
        visit_occurrence_id integer "[FK mrt_visit_occurrence] standardised unique visit id"
        source_table_provenance varchar "[NEW] source table name"
        source_row_id uuid "unique row id for the single concept that is generated at ingestion"
    }
```

### silver.mrt_condition_occurrence (SILVER)

This is the transformed version of ingested condition tables.  Concepts in this table are mapped to OMOP standards, and column naming is compatible, but it contains the following differences:

- Standardised concept codes/names are surfaced, and indexed, to enable user-friendly exploration and visualisation without the need for large joins;
- OMOP CDM 5.4 columns that are not relevant to the NHS, or to intended purposes, are initialised, but we do not populate. They remain empty when carried into omop.condition_occurrence;
- Source, table, and systems provenance are maintained, as well as human defined provenance type in `condition_type_concept_id` per OMOP.

```{mermaid}
---
title: OMOP_EXT Condition Occurrence
---
erDiagram
    mrt_condition_occurrence {
        condition_occurrence_id integer "[PK] autogenerated identifier"
        person_uuid uuid "[FK mrt_person] standardised unique person id"
        condition_start_date date
        condition_start_datetime timestamp
        condition_end_date date
        condition_end_datetime timestamp
        condition_concept_id integer "OMOP standard concept id"
        condition_concept_code varchar "OMOP standard concept code"
        condition_concept_name varchar "OMOP standard concept name"
        condition_type_concept_id integer "[FK not null] provenance of condition per OMOP - see notes"                
        condition_diagnosis_order integer "used where diagnoses are ordered, e.g. in commissioning data"
        stop_reason varchar "where given"
        visit_occurrence_id integer "[FK mrt_visit_occurrence] standardised unique visit id"
        condition_source_value varchar "condition code as represented in source"
        condition_source_value_name varchar "condition name as represented in source"        
        source_table_provenance varchar "source table name"
        source_row_id uuid "unique row id for the single concept that is generated at ingestion"
    }
```

### omop.condition_occurrence (GOLD, OMOP CDM 5.4)

This table contains records of Events of a Person suggesting the presence of a disease or medical condition stated as a diagnosis, a sign, or a symptom, which is either observed by a Provider or reported by the patient. The canonical OMOP table is shown below. 

```{mermaid}
---
title: OMOP Condition Occurrence
---
erDiagram
    condition_occurrence {
        condition_occurrence_id integer "[PK not null] autogenerated identifier"
        person_id integer "[FK not null]"
        condition_concept_id integer "[not null] standard OMOP concept id used for analyses"
        condition_start_date date "[not null]"
        condition_start_datetime timestamp
        condition_end_date date
        condition_end_datetime timestamp
        condition_type_concept_id integer "[not null] provenance of condition record per OMOP - see notes"
        condition_status_concept_id integer "how diagnosis was made - e.g. admission vs final"
        stop_reason varchar20 "why condition is no longer valid"
        provider_id integer "[FK] clinician provider who recorded condition"
        visit_occurrence_id integer "[FK]"
        visit_detail_id integer "[FK]"
        condition_source_value varchar50 "condition code as represented in source"
        condition_source_concept_id integer "mapping to omop but often left empty"
        condition_status_source_value varchar50 "condition status as represented in source"
    }
```
